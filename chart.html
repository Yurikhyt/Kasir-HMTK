<!-- Redesigned chart.html using same palette + style as history page -->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Grafik Penjualan â€” HMTK</title>
<link href="https://fonts.googleapis.com/css2?family=Fjalla+One&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --primary:#083107;
    --soft:#E3E19C;
    --accent:#EEAC10;
    --danger:#A41F0C;
    --bg:#faf9f4;
    --card:#ffffff;
  }
  body{background:linear-gradient(180deg,var(--bg),#fff);font-family:Nunito,sans-serif;margin:0;color:#122;}
  .topbar{background:var(--primary);color:var(--soft);padding:14px 22px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
  .topbar h1{margin:0;font-family:Fjalla One,sans-serif}
  .main-container{padding:20px;max-width:980px;margin:20px auto;display:flex;flex-direction:column;gap:24px}
  .card{background:var(--card);border-radius:12px;padding:18px;border:2px solid rgba(227,225,156,0.35);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h2{margin:0 0 12px 0;font-family:Fjalla One,sans-serif;color:var(--primary);text-align:center}
  .back-btn{background:var(--soft);color:var(--primary);padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700}
  canvas{width:100%!important;height:260px!important}
  @media(max-width:820px){.main-container{padding:12px}}
</style>
</head>
<body>
<div class="topbar">
  <h1>Grafik Penjualan</h1>
  <a href="kasir.html" class="back-btn">Kembali</a>
</div>

<div class="main-container" style="align-items:center;">
  <div style="display:flex;gap:12px;margin-bottom:16px;">
    <button id="downloadChart" style="padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:var(--soft);font-weight:700">Unduh Grafik</button>
    <button id="resetChart" style="padding:10px 14px;border-radius:8px;border:none;background:var(--danger);color:#fff;font-weight:700">Reset Grafik</button>
  </div>

  <div class="card" style="width:90%;max-width:780px;">
    <h2>Jumlah Transaksi Per Hari</h2>
    <canvas id="salesChart"></canvas>
  </div>

  <div class="card" style="width:90%;max-width:780px;">
    <h2>Total Omzet Per Hari</h2>
    <canvas id="omzetChart"></canvas>
  </div>
</div>

<script>
// === Chart Rendering Logic ===
const KEY_HISTORY = "kasir_history_v1";
const history = JSON.parse(localStorage.getItem(KEY_HISTORY)) || [];

const perHariCount = {}, perHariOmzet = {};
history.forEach(h => {
  const d = typeof h.tanggal === 'string' ? h.tanggal.split(',')[0].trim() : new Date(h.tanggal).toLocaleDateString();
  perHariCount[d] = (perHariCount[d]||0)+1;
  perHariOmzet[d] = (perHariOmzet[d]||0) + Number(h.total||0);
});

let labels = Object.keys(perHariCount).sort((a,b)=> new Date(a)-new Date(b));
const transaksiValues = labels.map(l=>perHariCount[l]);
const omzetValues = labels.map(l=>perHariOmzet[l]);

function safeChart(ctx, cfg){
  if(!ctx) return;
  if((cfg.data.labels||[]).length===0){ cfg.data.labels=["-"]; cfg.data.datasets.forEach(d=>d.data=[0]); }
  return new Chart(ctx,cfg);
}

safeChart(document.getElementById('salesChart'),{
  type:'bar',
  data:{labels:labels,datasets:[{label:'Transaksi',data:transaksiValues,backgroundColor:'#EEAC10',borderColor:'#083107',borderWidth:2}]},
  options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
});

safeChart(document.getElementById('omzetChart'),{
  type:'line',
  data:{labels:labels,datasets:[{label:'Omzet (Rp)',data:omzetValues,borderColor:'#083107',backgroundColor:'#EEAC10',borderWidth:3,tension:0.35}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{callbacks:{label:(c)=>`Rp ${Number(c.raw||0).toLocaleString('id-ID')}`}}},scales:{y:{beginAtZero:true,ticks:{callback:(v)=>'Rp '+Number(v).toLocaleString('id-ID')}}}}
});

// download charts
function downloadCanvas(id,name){
  const link=document.createElement('a');
  link.download=name+".png";
  link.href=document.getElementById(id).toDataURL();
  link.click();
}

document.getElementById('downloadChart').onclick=()=>{
  downloadCanvas('salesChart','grafik_transaksi');
  downloadCanvas('omzetChart','grafik_omzet');
};

// reset charts
document.getElementById('resetChart').onclick=()=>{
  localStorage.removeItem("kasir_history_v1");
  location.reload();
};
</script>
</body>
</html>
