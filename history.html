<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Riwayat Transaksi — HMTK</title>

<link href="https://fonts.googleapis.com/css2?family=Fjalla+One&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-header {
    width: 42px;
    height: 42px;
    object-fit: contain;
    border-radius: 6px;
    background: #ffffff;
    padding: 4px;
}

  :root{
    --primary:#083107;
    --soft:#E3E19C;
    --accent:#EEAC10;
    --danger:#A41F0C;
    --bg:#faf9f4;
    --card:#ffffff;
  }

  body{
    background:linear-gradient(180deg,var(--bg),#fff);
    font-family:Nunito, sans-serif;
    margin:0;
    color:#122;
  }

  .topbar{
    background:var(--primary);
    color:var(--soft);
    padding:14px 22px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .topbar h1{
    margin:0;
    font-family:Fjalla One, sans-serif;
  }

  .main-container{
    padding:20px;
    max-width:1100px;
    margin:20px auto;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  .card{
    width:100%;
    background:var(--card);
    border-radius:12px;
    padding:18px;
    border:2px solid rgba(227,225,156,0.35);
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }

  .card h2{
    font-family:Fjalla One, sans-serif;
    color:var(--primary);
    text-align:center;
    margin:0 0 15px 0;
  }

  .btn-area{
    display:flex;
    justify-content:center;
    gap:12px;
    margin-bottom:18px;
  }

  .btn{
    padding:10px 14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:700;
  }

  .btn-reset{background:var(--danger);color:white}
  .btn-export{background:var(--primary);color:var(--soft)}

  /* === UPDATE: SINGLE COLUMN === */
  #historyList{
    display:flex;
    flex-direction:column;
    gap:18px;
    width:100%;
    max-width:1000px;
    margin-top:6px;
  }

  .history-item{
    background:#fff;
    padding:20px;
    border-radius:12px;
    border-left:6px solid var(--accent);
    box-shadow:0 4px 12px rgba(0,0,0,0.06);
    width:100%;
  }

  .history-meta{
    display:flex;
    justify-content:space-between;
    margin-bottom:10px;
  }

  .items-list{margin:0;padding-left:18px}
  .muted{color:#666;font-size:14px}

  .empty-center{
    width:100%;
    height:200px;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:18px;
    color:#555;
    font-weight:600;
    text-align:center;
  }

  /* toast */
  #toastContainer{
    position:fixed;
    top:22px;
    right:22px;
    z-index:99999;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .toast{
    display:flex;
    align-items:center;
    gap:12px;
    padding:14px 18px;
    border-radius:12px;
    color:#fff;
    font-weight:700;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    position:relative;
  }

  .toast-success{background:#4caf50}
  .toast-error{background:#f44336}
  .toast-warning{background:#A41F0C}
  .toast-info{background:#2196f3}

  .toast-progress{
    position:absolute;
    bottom:0;
    left:0;
    height:4px;
    border-radius:100px;
    background:rgba(255,255,255,0.65);
    animation:toastProgress 3s linear forwards;
  }

  @keyframes toastProgress {
    from{width:100%}
    to{width:0}
  }
</style>
</head>
<body>

<div class="topbar">

  <div class="header-left">
      <img src="logo_hmtk.png" class="logo-header">
      <h1>Riwayat Transaksi</h1>
  </div>

  <a href="kasir.html" class="btn" style="background:var(--soft);color:var(--primary);border-radius:8px;padding:8px 12px;text-decoration:none;font-weight:700">Kembali</a>
</div>


<div class="main-container">
  <div class="card">
    <div class="btn-area">
      <button class="btn btn-reset" id="resetBtn">Reset Riwayat</button>
      <button class="btn btn-export" id="exportBtn">Export .xlsx</button>
    </div>

    <div id="historyList"></div>
  </div>
</div>

<div id="toastContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const KEY_HISTORY = "kasir_history_v1";
let history = JSON.parse(localStorage.getItem(KEY_HISTORY)) || [];

/*** TOAST ***/
function notify(msg,type='info'){
  const cont = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast toast-'+type;
  t.innerHTML = `<b>${
    type==='success'?'✔':
    type==='error'?'✖':
    type==='warning'?'⚠':'ℹ'
  }</b> ${msg}<div class="toast-progress"></div>`;
  cont.appendChild(t);
  setTimeout(()=> t.remove(),3500);
}

/*** CONFIRM MODAL ***/
function confirmModal(text, callback){
  const el = document.createElement('div');
  el.style = `
    position:fixed;left:0;top:0;right:0;bottom:0;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.35);z-index:999999;
  `;
  el.innerHTML = `
    <div style="background:#fff;padding:18px;border-radius:10px;min-width:300px;
                border:4px solid var(--accent);box-shadow:0 8px 24px rgba(0,0,0,0.18)">
      <div style="font-weight:800;color:var(--primary);margin-bottom:12px">Konfirmasi</div>
      <div style="margin-bottom:14px">${text}</div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="cmNo" style="padding:8px 12px;border-radius:8px;border:none;background:#ddd">Batal</button>
        <button id="cmYes" style="padding:8px 12px;border-radius:8px;border:none;background:var(--danger);color:#fff">Hapus</button>
      </div>
    </div>`;
  document.body.appendChild(el);

  cmNo.onclick = ()=> el.remove();
  cmYes.onclick = ()=>{ el.remove(); callback(); };
}

/*** RENDER RIWAYAT ***/
function renderHistory(){
  const box = document.getElementById('historyList');
  box.innerHTML = '';

  if(!history.length){
    box.innerHTML = `<div class="empty-center">Riwayat kosong.</div>`;
    return;
  }

  history.slice().reverse().forEach(h=>{
    const div = document.createElement('div');
    div.className = 'history-item';

    const meta = document.createElement('div');
    meta.className = 'history-meta';

    const left = document.createElement('div');
    left.innerHTML = `
      <strong>${h.tanggal}</strong>
      <div class="muted">Metode: ${h.metode}</div>
    `;

    const right = document.createElement('div');
    right.innerHTML = `<strong>Rp ${Number(h.total).toLocaleString('id-ID')}</strong>`;

    meta.appendChild(left);
    meta.appendChild(right);

    const items = document.createElement('ol');
    items.className = 'items-list';

    (h.items||[]).forEach(i=>{
      const li = document.createElement('li');
      li.innerHTML = `
  <strong>${i.nama}</strong>
  <span class="muted"> ×${i.qty} — Rp ${i.harga.toLocaleString('id-ID')}</span>
`;

      items.appendChild(li);
    });

    div.appendChild(meta);
    div.appendChild(items);
    box.appendChild(div);
  });
}

renderHistory();

/*** RESET RIWAYAT ***/
resetBtn.onclick = ()=>{
  confirmModal("Hapus semua riwayat transaksi?", ()=>{
    localStorage.removeItem(KEY_HISTORY);
    history = [];
    renderHistory();
    notify("Riwayat berhasil direset","warning");
  });
};

/*** EXPORT XLSX ***/
exportBtn.onclick = ()=>{
  if(!history.length){ notify("Tidak ada data untuk diekspor","error"); return; }

  const rows = history.map(h=>({
    Tanggal: h.tanggal,
    Metode: h.metode,
    Total: h.total,
    Items: (h.items||[]).map(i=>`${i.nama} x${i.qty} (Rp ${(i.harga * i.qty)})`).join(', ')
  }));

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Riwayat");
  XLSX.writeFile(wb,"riwayat_transaksi.xlsx");

  notify("Export Excel berhasil!","success");
};
</script>

</body>
</html>
